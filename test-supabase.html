<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #3b82f6;
            margin-bottom: 30px;
        }
        .test {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .test.success {
            border-left-color: #10b981;
            background: #ecfdf5;
        }
        .test.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .test.loading {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-icon {
            font-size: 20px;
        }
        .test-details {
            color: #666;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .button-group {
            margin: 30px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background: #d1d5db;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            border-radius: 4px;
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
        }
        .summary h2 {
            margin-top: 0;
            color: #3b82f6;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Supabase Connection Test</h1>
        
        <div id="tests"></div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="runAllTests()">Run All Tests</button>
            <button class="btn-secondary" onclick="location.reload()">Clear Results</button>
        </div>
        
        <div id="summary" class="summary" style="display: none;">
            <h2>üìä Test Summary</h2>
            <div id="summary-content"></div>
        </div>
    </div>

    <script type="module">
        window.runAllTests = async function() {
            const testsDiv = document.getElementById('tests');
            testsDiv.innerHTML = '';
            
            // IMPORTANT: For testing only - in production, use environment variables
            const SUPABASE_URL = 'https://ntoywdjhihbzuatybafv.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50b3l3ZGpoaWhienVhdHliYWZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzM1NzEsImV4cCI6MjA3ODUwOTU3MX0.J7rG5nOJigfhpqQZZXNbKkhfcrNkNewwqA3cTAlPNpQ';
            
            // Create test elements
            const testIds = [
                'env-check',
                'import-sdk',
                'create-client',
                'connection-test',
                'tables-check',
                'data-test'
            ];
            
            testIds.forEach(id => {
                const test = document.createElement('div');
                test.id = id;
                test.className = 'test loading';
                test.innerHTML = `
                    <div class="test-title">
                        <span class="status-icon">‚è≥</span>
                        <span id="${id}-title">Running...</span>
                    </div>
                    <div class="test-details" id="${id}-details"></div>
                `;
                testsDiv.appendChild(test);
            });
            
            const results = {
                passed: 0,
                failed: 0,
                details: []
            };
            
            // Test 1: Environment Variables (Hardcoded for browser)
            try {
                const envTest = document.getElementById('env-check');
                const envDetails = document.getElementById('env-check-details');
                
                if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                    envTest.className = 'test success';
                    document.getElementById('env-check-title').textContent = '‚úÖ Credentials Loaded';
                    envDetails.textContent = `URL: ${SUPABASE_URL}\nKey: ${SUPABASE_ANON_KEY.substring(0, 20)}...`;
                    results.passed++;
                    results.details.push('Credentials loaded successfully');
                } else {
                    throw new Error('Missing credentials');
                }
            } catch (err) {
                const envTest = document.getElementById('env-check');
                envTest.className = 'test error';
                document.getElementById('env-check-title').textContent = '‚ùå Credentials Error';
                document.getElementById('env-check-details').textContent = err.message;
                results.failed++;
                results.details.push(`Credentials test failed: ${err.message}`);
            }
            
            // Test 2: Import SDK
            try {
                const importTest = document.getElementById('import-sdk');
                document.getElementById('import-sdk-title').textContent = '‚è≥ Testing SDK Import...';
                
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
                
                importTest.className = 'test success';
                document.getElementById('import-sdk-title').textContent = '‚úÖ Supabase SDK Imported';
                document.getElementById('import-sdk-details').textContent = '@supabase/supabase-js v2 loaded successfully';
                results.passed++;
                results.details.push('SDK imported successfully');
                
                // Store for later use
                window.createClient = createClient;
            } catch (err) {
                const importTest = document.getElementById('import-sdk');
                importTest.className = 'test error';
                document.getElementById('import-sdk-title').textContent = '‚ùå SDK Import Error';
                document.getElementById('import-sdk-details').textContent = err.message;
                results.failed++;
                results.details.push(`SDK import failed: ${err.message}`);
            }
            
            // Test 3: Create Client
            try {
                const clientTest = document.getElementById('create-client');
                document.getElementById('create-client-title').textContent = '‚è≥ Creating Client...';
                
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
                
                const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                clientTest.className = 'test success';
                document.getElementById('create-client-title').textContent = '‚úÖ Client Created';
                document.getElementById('create-client-details').textContent = `Connected to:\n${SUPABASE_URL}`;
                results.passed++;
                results.details.push('Supabase client created successfully');
                
                window.supabase = supabase;
            } catch (err) {
                const clientTest = document.getElementById('create-client');
                clientTest.className = 'test error';
                document.getElementById('create-client-title').textContent = '‚ùå Client Creation Error';
                document.getElementById('create-client-details').textContent = err.message;
                results.failed++;
                results.details.push(`Client creation failed: ${err.message}`);
                return finalizeSummary();
            }
            
            // Test 4: Connection Test
            try {
                const connTest = document.getElementById('connection-test');
                document.getElementById('connection-test-title').textContent = '‚è≥ Testing Connection...';
                
                const { data, error } = await window.supabase.from('students').select('count');
                
                if (error) throw error;
                
                connTest.className = 'test success';
                document.getElementById('connection-test-title').textContent = '‚úÖ Connection Successful';
                document.getElementById('connection-test-details').textContent = `Successfully connected to Supabase!\nServer responded successfully`;
                results.passed++;
                results.details.push('Connection test passed');
            } catch (err) {
                const connTest = document.getElementById('connection-test');
                connTest.className = 'test error';
                document.getElementById('connection-test-title').textContent = '‚ùå Connection Error';
                document.getElementById('connection-test-details').textContent = `Error: ${err.message}\n\nNote: This might be due to RLS - make sure SUPABASE_RLS_SETUP.sql has been run.`;
                results.failed++;
                results.details.push(`Connection test failed: ${err.message}`);
            }
            
            // Test 5: Tables Check
            try {
                const tablesTest = document.getElementById('tables-check');
                document.getElementById('tables-check-title').textContent = '‚è≥ Checking Tables...';
                
                const tables = ['students', 'contacts', 'groups', 'student_groups', 'attendance', 'payments', 'events'];
                const results_tables = [];
                
                for (const table of tables) {
                    try {
                        const { error } = await window.supabase.from(table).select('count', { count: 'exact' });
                        results_tables.push(`${error ? '‚ùå' : '‚úÖ'} ${table}`);
                    } catch (err) {
                        results_tables.push(`‚ùå ${table}`);
                    }
                }
                
                tablesTest.className = 'test success';
                document.getElementById('tables-check-title').textContent = '‚úÖ Tables Checked';
                document.getElementById('tables-check-details').textContent = results_tables.join('\n');
                results.passed++;
                results.details.push('Tables check completed');
            } catch (err) {
                const tablesTest = document.getElementById('tables-check');
                tablesTest.className = 'test error';
                document.getElementById('tables-check-title').textContent = '‚ùå Tables Check Error';
                document.getElementById('tables-check-details').textContent = err.message;
                results.failed++;
                results.details.push(`Tables check failed: ${err.message}`);
            }
            
            // Test 6: Data Test
            try {
                const dataTest = document.getElementById('data-test');
                document.getElementById('data-test-title').textContent = '‚è≥ Testing Data Access...';
                
                const { data, error, count } = await window.supabase
                    .from('students')
                    .select('*', { count: 'exact' });
                
                if (error) throw error;
                
                dataTest.className = 'test success';
                document.getElementById('data-test-title').textContent = '‚úÖ Data Access Working';
                document.getElementById('data-test-details').textContent = `‚úì Can read student records\n‚úì Total students: ${count || 0}\n‚úì RLS policies applied correctly`;
                results.passed++;
                results.details.push(`Data access test passed (${count || 0} records)`);
            } catch (err) {
                const dataTest = document.getElementById('data-test');
                dataTest.className = 'test error';
                document.getElementById('data-test-title').textContent = '‚ùå Data Access Error';
                document.getElementById('data-test-details').textContent = `Error: ${err.message}\n\nMake sure RLS policies have been applied with SUPABASE_RLS_SETUP.sql`;
                results.failed++;
                results.details.push(`Data access test failed: ${err.message}`);
            }
            
            function finalizeSummary() {
                const summary = document.getElementById('summary');
                const summaryContent = document.getElementById('summary-content');
                
                let statusColor = results.failed === 0 ? '#10b981' : '#ef4444';
                let statusText = results.failed === 0 ? '‚úÖ All Tests Passed!' : `‚ö†Ô∏è ${results.failed} Test(s) Failed`;
                
                summaryContent.innerHTML = `
                    <div style="color: ${statusColor}; font-weight: bold; font-size: 18px; margin-bottom: 15px;">
                        ${statusText}
                    </div>
                    <table>
                        <tr>
                            <th>Metric</th>
                            <th>Result</th>
                        </tr>
                        <tr>
                            <td>Tests Passed</td>
                            <td style="color: #10b981; font-weight: bold;">‚úÖ ${results.passed}</td>
                        </tr>
                        <tr>
                            <td>Tests Failed</td>
                            <td style="color: ${results.failed > 0 ? '#ef4444' : '#10b981'}; font-weight: bold;">${results.failed > 0 ? '‚ùå' : '‚úÖ'} ${results.failed}</td>
                        </tr>
                        <tr>
                            <td>Total Tests</td>
                            <td>${results.passed + results.failed}</td>
                        </tr>
                    </table>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; color: #666; font-size: 13px;">
                        <strong>Details:</strong><br>
                        ${results.details.map(d => `‚Ä¢ ${d}`).join('<br>')}
                    </div>
                    ${results.failed === 0 ? `
                        <div style="margin-top: 15px; padding: 15px; background: #ecfdf5; border-left: 4px solid #10b981; border-radius: 4px;">
                            <strong style="color: #10b981;">‚ú® Ready to Deploy!</strong><br>
                            Your Supabase connection is working perfectly. You can now:<br>
                            1. Run <code>npm run dev</code> to start the dashboard<br>
                            2. Create and manage students, payments, attendance, etc.<br>
                            3. All data will be persisted in Supabase
                        </div>
                    ` : `
                        <div style="margin-top: 15px; padding: 15px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                            <strong style="color: #ef4444;">‚ö†Ô∏è Issues Detected</strong><br>
                            Please check the test results above for details on what needs to be fixed.
                        </div>
                    `}
                `;
                
                summary.style.display = 'block';
            }
            
            finalizeSummary();
        };
    </script>
            
            // Test 2: Import SDK
            try {
                const importTest = document.getElementById('import-sdk');
                document.getElementById('import-sdk-title').textContent = '‚è≥ Testing SDK Import...';
                
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
                
                importTest.className = 'test success';
                document.getElementById('import-sdk-title').textContent = '‚úÖ Supabase SDK Imported';
                document.getElementById('import-sdk-details').textContent = '@supabase/supabase-js v2 loaded successfully';
                results.passed++;
                results.details.push('SDK imported successfully');
                
                // Store for later use
                window.createClient = createClient;
            } catch (err) {
                const importTest = document.getElementById('import-sdk');
                importTest.className = 'test error';
                document.getElementById('import-sdk-title').textContent = '‚ùå SDK Import Error';
                document.getElementById('import-sdk-details').textContent = err.message;
                results.failed++;
                results.details.push(`SDK import failed: ${err.message}`);
            }
            
            // Test 3: Create Client
            try {
                const clientTest = document.getElementById('create-client');
                document.getElementById('create-client-title').textContent = '‚è≥ Creating Client...';
                
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
                
                const url = import.meta.env.VITE_SUPABASE_URL;
                const key = import.meta.env.VITE_SUPABASE_ANON_KEY;
                
                const supabase = createClient(url, key);
                
                clientTest.className = 'test success';
                document.getElementById('create-client-title').textContent = '‚úÖ Client Created';
                document.getElementById('create-client-details').textContent = `Connected to:\n${url}`;
                results.passed++;
                results.details.push('Supabase client created successfully');
                
                window.supabase = supabase;
            } catch (err) {
                const clientTest = document.getElementById('create-client');
                clientTest.className = 'test error';
                document.getElementById('create-client-title').textContent = '‚ùå Client Creation Error';
                document.getElementById('create-client-details').textContent = err.message;
                results.failed++;
                results.details.push(`Client creation failed: ${err.message}`);
                return finalizeSummary();
            }
            
            // Test 4: Connection Test
            try {
                const connTest = document.getElementById('connection-test');
                document.getElementById('connection-test-title').textContent = '‚è≥ Testing Connection...';
                
                const { data, error } = await window.supabase.from('students').select('count');
                
                if (error) throw error;
                
                connTest.className = 'test success';
                document.getElementById('connection-test-title').textContent = '‚úÖ Connection Successful';
                document.getElementById('connection-test-details').textContent = `Successfully connected to Supabase!\nServer responded successfully`;
                results.passed++;
                results.details.push('Connection test passed');
            } catch (err) {
                const connTest = document.getElementById('connection-test');
                connTest.className = 'test error';
                document.getElementById('connection-test-title').textContent = '‚ùå Connection Error';
                document.getElementById('connection-test-details').textContent = `Error: ${err.message}\n\nNote: This might be due to RLS - make sure SUPABASE_RLS_SETUP.sql has been run.`;
                results.failed++;
                results.details.push(`Connection test failed: ${err.message}`);
            }
            
            // Test 5: Tables Check
            try {
                const tablesTest = document.getElementById('tables-check');
                document.getElementById('tables-check-title').textContent = '‚è≥ Checking Tables...';
                
                const tables = ['students', 'contacts', 'groups', 'student_groups', 'attendance', 'payments', 'events'];
                const results_tables = [];
                
                for (const table of tables) {
                    try {
                        const { error } = await window.supabase.from(table).select('count', { count: 'exact' });
                        results_tables.push(`${error ? '‚ùå' : '‚úÖ'} ${table}`);
                    } catch (err) {
                        results_tables.push(`‚ùå ${table}`);
                    }
                }
                
                tablesTest.className = 'test success';
                document.getElementById('tables-check-title').textContent = '‚úÖ Tables Checked';
                document.getElementById('tables-check-details').textContent = results_tables.join('\n');
                results.passed++;
                results.details.push('Tables check completed');
            } catch (err) {
                const tablesTest = document.getElementById('tables-check');
                tablesTest.className = 'test error';
                document.getElementById('tables-check-title').textContent = '‚ùå Tables Check Error';
                document.getElementById('tables-check-details').textContent = err.message;
                results.failed++;
                results.details.push(`Tables check failed: ${err.message}`);
            }
            
            // Test 6: Data Test
            try {
                const dataTest = document.getElementById('data-test');
                document.getElementById('data-test-title').textContent = '‚è≥ Testing Data Access...';
                
                const { data, error, count } = await window.supabase
                    .from('students')
                    .select('*', { count: 'exact' });
                
                if (error) throw error;
                
                dataTest.className = 'test success';
                document.getElementById('data-test-title').textContent = '‚úÖ Data Access Working';
                document.getElementById('data-test-details').textContent = `‚úì Can read student records\n‚úì Total students: ${count || 0}\n‚úì RLS policies applied correctly`;
                results.passed++;
                results.details.push(`Data access test passed (${count || 0} records)`);
            } catch (err) {
                const dataTest = document.getElementById('data-test');
                dataTest.className = 'test error';
                document.getElementById('data-test-title').textContent = '‚ùå Data Access Error';
                document.getElementById('data-test-details').textContent = `Error: ${err.message}\n\nMake sure RLS policies have been applied with SUPABASE_RLS_SETUP.sql`;
                results.failed++;
                results.details.push(`Data access test failed: ${err.message}`);
            }
            
            function finalizeSummary() {
                const summary = document.getElementById('summary');
                const summaryContent = document.getElementById('summary-content');
                
                let statusColor = results.failed === 0 ? '#10b981' : '#ef4444';
                let statusText = results.failed === 0 ? '‚úÖ All Tests Passed!' : `‚ö†Ô∏è ${results.failed} Test(s) Failed`;
                
                summaryContent.innerHTML = `
                    <div style="color: ${statusColor}; font-weight: bold; font-size: 18px; margin-bottom: 15px;">
                        ${statusText}
                    </div>
                    <table>
                        <tr>
                            <th>Metric</th>
                            <th>Result</th>
                        </tr>
                        <tr>
                            <td>Tests Passed</td>
                            <td style="color: #10b981; font-weight: bold;">‚úÖ ${results.passed}</td>
                        </tr>
                        <tr>
                            <td>Tests Failed</td>
                            <td style="color: ${results.failed > 0 ? '#ef4444' : '#10b981'}; font-weight: bold;">${results.failed > 0 ? '‚ùå' : '‚úÖ'} ${results.failed}</td>
                        </tr>
                        <tr>
                            <td>Total Tests</td>
                            <td>${results.passed + results.failed}</td>
                        </tr>
                    </table>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; color: #666; font-size: 13px;">
                        <strong>Details:</strong><br>
                        ${results.details.map(d => `‚Ä¢ ${d}`).join('<br>')}
                    </div>
                    ${results.failed === 0 ? `
                        <div style="margin-top: 15px; padding: 15px; background: #ecfdf5; border-left: 4px solid #10b981; border-radius: 4px;">
                            <strong style="color: #10b981;">‚ú® Ready to Deploy!</strong><br>
                            Your Supabase connection is working perfectly. You can now:<br>
                            1. Run <code>npm run dev</code> to start the dashboard<br>
                            2. Create and manage students, payments, attendance, etc.<br>
                            3. All data will be persisted in Supabase
                        </div>
                    ` : `
                        <div style="margin-top: 15px; padding: 15px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                            <strong style="color: #ef4444;">‚ö†Ô∏è Issues Detected</strong><br>
                            Please check the test results above for details on what needs to be fixed.
                        </div>
                    `}
                `;
                
                summary.style.display = 'block';
            }
            
            finalizeSummary();
        };
    </script>

    <div style="margin-top: 30px; padding: 20px; background: #f3f4f6; border-radius: 4px;">
        <h3>üìñ How to Use This Test</h3>
        <ol>
            <li>Click "Run All Tests" button above</li>
            <li>Wait for all tests to complete</li>
            <li>Review the results:
                <ul>
                    <li>‚úÖ = Test passed</li>
                    <li>‚ùå = Test failed (see details)</li>
                    <li>‚è≥ = Test running</li>
                </ul>
            </li>
            <li>If all tests pass, your setup is complete!</li>
            <li>If tests fail, check the troubleshooting guide in SETUP_COMPLETE.md</li>
        </ol>
    </div>
</body>
</html>
